---
slug: pragtical-v380-release
title: Pragtical v3.8.0 Release
authors: jgmdev
---

Many fixes and new features like the image viewer, built-in color picker,
support for drawing polygons, introduction of a canvas api and experimental
live search!

<!-- truncate -->

## Generalized RenCache

One prominent change is that the rencache source code was generalized to
decouple it of the windows renderer, this allows using it in other contexts
like the new canvas, which helps it perform better by leveraging the rencache
feature of skipping unnecessary drawing operations.

Expanding on this subject, the rencache incorporates the following new struct
with parts decoupled from renwindow:

```c
typedef struct {
  uint8_t *command_buf;
  size_t command_buf_idx;
  size_t command_buf_size;
  unsigned cells_buf1[RENCACHE_CELLS_X * RENCACHE_CELLS_Y];
  unsigned cells_buf2[RENCACHE_CELLS_X * RENCACHE_CELLS_Y];
  unsigned *cells_prev;
  unsigned *cells;
  RenRect rect_buf[RENCACHE_CELLS_X * RENCACHE_CELLS_Y / 2];
  bool resize_issue;
  RenRect screen_rect;
  RenRect last_clip_rect;
  SDL_Window *window;   /* The cache can be used for both a window or surface */
  RenSurface rensurface;
#ifdef PRAGTICAL_USE_SDL_RENDERER
  SDL_Renderer *renderer;
  SDL_Texture *texture;
#endif
} RenCache;
```

Also, the rencache function interfaces now look like this:

```c
void rencache_init(RenCache *rc);
void rencache_uninit(RenCache *rc);
void  rencache_show_debug(bool enable);
void  rencache_set_clip_rect(RenCache *rc, RenRect rect);
void  rencache_draw_rect(RenCache *rc, RenRect rect, RenColor color, bool replace);
double rencache_draw_text(RenCache *rc, RenFont **font, const char *text, size_t len, double x, double y, RenColor color, RenTab tab);
RenRect rencache_draw_poly(RenCache *rc, RenPoint *points, int npoints, RenColor color);
void  rencache_draw_canvas(RenCache *ren_cache, RenRect rect, RenCache *canvas);
void  rencache_draw_pixels(RenCache *ren_cache, RenRect rect, const char* bytes, size_t len);
void  rencache_invalidate(RenCache *rc);
void  rencache_begin_frame(RenCache *rc);
void  rencache_end_frame(RenCache *rc);
RenSurface rencache_get_surface(RenCache *rc);
void rencache_update_rects(RenCache *rc, RenRect *rects, int count);
```

As you may notice, this release introduces the new `rencache_draw_poly` and
`rencache_draw_canvas` functions. Now lets talk about the new user facing changes!

## Image Viewer

Now you don't have to leave the editor to view an image with the built-in
image viewer, which leverages sdl3_image with support for basic svg rendering.
The list of built-in supported image types are: bmp, cur, gif, ico, jpg, lbm, pcx,
png, pnm, qoi, svg, tga, xcf xpm and xv. The supported formats that require
an external library to work are: avif, jxl, webp and until we improve the custom
sdl3_image meson wrapper, tiff (which doesn't actually works on macOS and Windows).

<video muted style={{width: '100%'}} controls>
  <source src="https://github.com/user-attachments/assets/480dcfee-f63d-445f-9948-54042716a83b"/>
</video>

You can take a look at the new
[ImageView](https://github.com/pragtical/pragtical/blob/master/data/core/imageview.lua)
object.

## Built-in Color Picker

The new built-in color picker will also assist on not having to leave the
editor to pick a color :P. It allows you to pick an RGB or HEX color from
any part of the editor UI and save it to the clipboard so you can use it
wherever you like.

<video muted style={{width: '100%'}} controls>
  <source src="https://github.com/user-attachments/assets/16fec786-ecbb-4c1c-bda5-b77bd17606dc"/>
</video>

This is possible thanks to new `renwindow.get_color` api function:

```lua
---
---Gets the window pixel color of the specified position.
---
---@param window renwindow
---@param x number
---@param y number
---
---@return renderer.color? color
function renwindow.get_color(window, x, y) end
```

## Experimental Live Search

This release also introduces project search results syntax coloring and
experimental live search support which was a nice suggestion by [Amer](https://github.com/AmerM137).
The live search support may cause undesired effects so use with cautious until
bugs are ironed out on next releases. The plan for next releases is to also
integrate it on the current file search with both the project search and file
search offering an option to show them on a floating widget on the center
of the screen, but for the moment enjoy the initial work!

<video muted style={{width: '100%'}} controls>
  <source src="https://github.com/user-attachments/assets/418b1be2-59f6-4dc1-9d50-375af7a3c1d8"/>
</video>

## Polygons Drawing Support

Polygons! the new `renderer.draw_poly` was merged from Takase work on
[#1857](https://github.com/lite-xl/lite-xl/pull/1857) and it leverages freetype
advanced drawing capabilities. The feature was adapted to work with the
generalized rencache changes in Pragtical. The api function allows to draw
smooth shapes and it was also incorporated to the new canvas api.

![pragtical polygons](https://github.com/user-attachments/assets/99153d31-f902-4a00-aa59-1fe55d2c2cbc)

## Canvas

Meanwhile, the new canvas code is an adaptation of Guldo branch
[PR_canvas](https://github.com/Guldoman/lite-xl/tree/PR_canvas) and it was
also modified to use the new generalized rencache changes which helps get
rid of those unnecessary draw calls improving its performance! Also to
this api we introduced, draw_poly as image loading and saving support. We added
the following additional functions to this api:

```lua
---
---Loads an image into a new canvas.
---
---@param path string
---
---@return canvas? canvas
---@return string? errmsg
function canvas.load_image(path) end

---
---Loads an svg image with the specified width and height.
---
---@param path string
---@param width integer
---@param height integer
---
---@return canvas? canvas
---@return string? errmsg
function canvas.load_svg_image(path, width, height) end

---
---Clean the canvas, content will be replaced with transparent pixels,
---or a full opaque color if the canvas is not transparent.
---
---@param color? renderer.color Optional color used to fill the surface.
function canvas:clear(color) end

---
---Draws a filled polygon, consisting of curves and points.
---The polygon is filled using the non-zero winding rule in clockwise direction.
---
---The function returns the control box of the polygon,
---which is greater than or equal to the dimensions of the rendered polygon.
---It is not guaranteed to the exact dimension of the rendered polygon.
---
---@param poly renderer.poly_object[] the lines or curves to draw, up to 65535 points.
---@param color renderer.color
---
---@return number x the X coordinate of top left corner of the control box.
---@return number y the Y coordinate of the top left corner of the control box.
---@return number w the width of the control box.
---@return number h the height of the control box.
function canvas:draw_poly(poly, color) end

---
---Explicitly render all the draw commands sent to the canvas so far
---without having to render the canvas into a window first.
---
function canvas:render() end

---
---Save the current canvas as an image.
---
---@param filename string
---@param type? "png" | "jpg" | "avif" Defaults to "png"
---@param quality? integer A number from 1 to 100 used for jpg and avif. Defaults to 100
---
---@return boolean saved
---@return string? errmsg
function canvas:save_image(filename, type, quality) end
```

For all the functionality of this api consult its
[doc file](https://github.com/pragtical/pragtical/blob/master/docs/api/canvas.lua).

## More Bug Fixes

Finally, this release incorporates various bug fixes and enhancements for:

* Lua Core
* The Build System
* Widgets

Some of these changes and fixes are thanks to contributors like:

* [M4he](https://github.com/M4he) who reported the contextmenu triggering on
  window manager resize. And also reported the Plugin Manager view stealing
  mouse clicks from tab bar.

Also, various upstream changes made it in with additional work from us to
improve them as fixing regressions they introduced. Check the Changes Log
below for more!

Downloads on [GitHub](https://github.com/pragtical/pragtical/releases/tag/v3.8.0).

## Changes Log

### New Features

* Add a built-in color picker
  ([#375](https://github.com/pragtical/pragtical/pull/375))

  - Document new renwindow.get_color
    ([c60ee0d9](https://github.com/pragtical/pragtical/commit/c60ee0d990e9b03e8fa63210f159f7b14f95b139))

  - Use proper add keymap function on rootpickcolor plugin
    ([71af13e6](https://github.com/pragtical/pragtical/commit/71af13e6949e8c88ad31062ec5f72a4619128d76))

  - rootpickcolor: forgot to properly return on_mouse_pressed
    ([2c1a6944](https://github.com/pragtical/pragtical/commit/2c1a6944544248f02b4651d50d419b57f646b45c))

* Live refresh and coloring for projectsearch plugin
  ([#377](https://github.com/pragtical/pragtical/pull/377))

* Image Viewer (directly added on merged canvas support)
  ([#370](https://github.com/pragtical/pragtical/pull/370))

### Core Changes

* Generalize the rendering cache system
  ([#368](https://github.com/pragtical/pragtical/pull/368))

* Merged: Add support for drawing polygons (adapted to generalized rencache)
  ([#369](https://github.com/pragtical/pragtical/pull/369))

* Merged: canvas (adapted to generalized rencache, added poly draw, additional image loading support and image viewer)
  ([#370](https://github.com/pragtical/pragtical/pull/370))

  - Add the option to change background mode of images
    ([#371](https://github.com/pragtical/pragtical/pull/371))

  - ImageView: keep scale at 1 if width less than view
    ([e9c305ed](https://github.com/pragtical/pragtical/commit/e9c305ed9cca34c15701ea882c5b1b4db230f482))

  - ImageView: rescale svg images directly from source
    ([#383](https://github.com/pragtical/pragtical/pull/383))

### Fixes

* Fix contextmenu triggered on window manager resize
  ([#356](https://github.com/pragtical/pragtical/pull/356))

* Update config.mouse_wheel_scroll on scale changes
  ([#361](https://github.com/pragtical/pragtical/pull/361))

* Scale initialization fixes
  ([#362](https://github.com/pragtical/pragtical/pull/362))

* Fix equal float comparison returning false
  ([#363](https://github.com/pragtical/pragtical/pull/363))

* Replace settings ui scroll wheel set with on_apply
  ([eef5ef1e](https://github.com/pragtical/pragtical/commit/eef5ef1eae7bc75d7a1a8dae274a0316402ffc37))

* Fix EmptyView AKA Welcome Screen flashing
  ([#366](https://github.com/pragtical/pragtical/pull/366))

* Fix the statusview tooltips jumpy text
  ([#367](https://github.com/pragtical/pragtical/pull/367))

* Fix treeview new file/folder regression (fix for inherited changes)
  ([cb06c0fd](https://github.com/pragtical/pragtical/commit/cb06c0fd86e050c8d2d8283e12c3c58ff848be98))

* Remove unneccesary save when loading project module (fix for inherited changes)
  ([fe217606](https://github.com/pragtical/pragtical/commit/fe217606ae0cca636405b357982d8290642e1801))

* Fixes to threads and channels code
  ([#376](https://github.com/pragtical/pragtical/pull/376))

* Fix inconsistency on toolbarview dest_size
  ([#378](https://github.com/pragtical/pragtical/pull/378))

* Fix system.list_dir to work with / (sdl3 port regression)
  ([#379](https://github.com/pragtical/pragtical/pull/379))

* Guard against null windows on draw operations
  ([#381](https://github.com/pragtical/pragtical/pull/381))

* Fix support for larger posix process reading (fix for inherited changes and real cause of PGO CI failures)
  ([73b60926](https://github.com/pragtical/pragtical/commit/73b609264bb211c75ef94b4b9da6377df81158d6))

* TreeView: round size.x on move_towards
  ([#384](https://github.com/pragtical/pragtical/pull/384))

### Enhancements

* Add option to show repainted areas
  ([#358](https://github.com/pragtical/pragtical/pull/358))

* Better out of box smoothness and responsiveness
  ([#357](https://github.com/pragtical/pragtical/pull/357))

### Widgets

* Properly return from updates and draws
  ([8743ec6f](https://github.com/pragtical/widget/commit/8743ec6f9678317b12309ff82af2a4406387aba4))

* keep list properly resized on selectbox
  ([abad16b2](https://github.com/pragtical/widget/commit/abad16b2de043e2173ce9419db6485189e0cd412))

* Ensure draw is called after a proper update
  ([dc3bdd3a](https://github.com/pragtical/widget/commit/dc3bdd3a3c56ffb6dc5266386c7f0c10519c8974))

* SearchReplaceList: allow syntax highlighting on search results
  ([623b88be](https://github.com/pragtical/widget/commit/623b88be75aefef8e291721ba4fe549459cba398))

* TextBox: simplified placeholder logic
  ([e8ffacbf](https://github.com/pragtical/widget/commit/e8ffacbfaeba93361d5f46d72de0065da4d35bc3))

* SearchReplaceList: correction to skip draw logic
  ([ba3bde34](https://github.com/pragtical/widget/commit/ba3bde34589f0d703b99db7ec6fdc6fabd96af6d))

### Build System

* Fix pgo stresser getting stalled on CI (the endeavour)
  ([b044ce4c](https://github.com/pragtical/pragtical/commit/b044ce4cc806ddb01a86fb19b395475c8a01cc43))

  - Other changes to prevent pgo from stalling
    ([64472f48](https://github.com/pragtical/pragtical/commit/64472f4850d55c73e4af8e30c25363b80313824c))

  - Disable system sleep and poll_event to try fix CI stall
    ([a8597926](https://github.com/pragtical/pragtical/commit/a8597926ec05977813526488bfbfe19412fec168))

  - Timeout pgo stress to prevent stall
    ([eac0b44b](https://github.com/pragtical/pragtical/commit/eac0b44b408eee7675e1666f2ae0a30c63b523ba))

  - Remove ci lua system overrides and disable pgo sqlite download
    ([f05047a0](https://github.com/pragtical/pragtical/commit/f05047a050c28b0bb13c264043a3cfd062ed6ca7))

  - Restore pgo sqlite download stress
    ([86b89ae8](https://github.com/pragtical/pragtical/commit/86b89ae8c3a79701ab51f420771f11f0f1c31544))

  - Real cause of PGO stalls renferenced on fixes section
   ([73b60926](https://github.com/pragtical/pragtical/commit/73b609264bb211c75ef94b4b9da6377df81158d6))

* Fixes to rolling and release CI linux build
  ([#372](https://github.com/pragtical/pragtical/pull/372))

* Disable uchardet tests compilation
  ([#374](https://github.com/pragtical/pragtical/pull/374))

*  Update sdl to v3.2.28
  ([#373](https://github.com/pragtical/pragtical/pull/373))

* Update macOS x86 runner
  ([66c75376](https://github.com/pragtical/pragtical/commit/66c75376142a6440112ac4eabaeebaa83c5c693b))

* Initial support for [muon](https://github.com/muon-build/muon) build
  ([#380](https://github.com/pragtical/pragtical/pull/380))

* Fix luajit crosscompilation for muon
  ([#382](https://github.com/pragtical/pragtical/pull/382))

* PPM subproject: download git submodules on demand
  ([#385](https://github.com/pragtical/pragtical/pull/385))

### Miscelaneous

* Keep icon svg segments on repo
  ([16539334](https://github.com/pragtical/pragtical/commit/16539334889e696ca5e1db9486fa6246661dea75))

* GIT ignore subprojects/.wraplock
  ([b5017edc](https://github.com/pragtical/pragtical/commit/b5017edcdd239baea1ab0b2ecdd775b011bc5a72))

* Remove leftover print statement (from inherited changes)
  ([2b1c750a](https://github.com/pragtical/pragtical/commit/2b1c750a270da3c20301c4c36c6dfd7e42d899f2))

### Lite XL Inherited Changes (with corrections and improvements)

* Fixed timeout in process:wait; comparison
  ([5a36b3f0](https://github.com/pragtical/pragtical/commit/5a36b3f07adeb3d5c0629c1f073c5931a471c355))

* system: update window scale on scale changes
  ([#2081](https://github.com/lite-xl/lite-xl/pull/2081))

* Improve folder drag-and-drop experience
  ([#1830](https://github.com/lite-xl/lite-xl/pull/1830))

* Resolved some type-complaints that are detected by LuaLS
  ([#2120](https://github.com/lite-xl/lite-xl/pull/2120))

* Backporting ancient fix to allow for large amounts of reading.
  ([#1547](https://github.com/lite-xl/lite-xl/pull/1547))

* Update renwindow.lua
  ([#2150](https://github.com/lite-xl/lite-xl/pull/2150))

* Adjusted parameter order and docs for renwindow create.
  ([#2155](https://github.com/lite-xl/lite-xl/pull/2155))

* Fix wrong suggestion when creating file or folder in treeview
  ([#2183](https://github.com/lite-xl/lite-xl/pull/2183))

* fix(doc): don't modify doc with empty clipboard paste
  ([#2185](https://github.com/lite-xl/lite-xl/pull/2185))

* fix(treeview): avoid crashing if creating a new file errors out
  ([#2184](https://github.com/lite-xl/lite-xl/pull/2184))

* Rearrange Plugin Loading and SDL Initialization (#1881)
  ([#1881](https://github.com/lite-xl/lite-xl/pull/1881))

* Added generic storage system and use on workspace plugin
  ([#1929](https://github.com/lite-xl/lite-xl/pull/1929))

* feat: add SDL file picker
  ([#2072](https://github.com/lite-xl/lite-xl/pull/2072))

* Allow for negative priority numbers.
  ([7d636075](https://github.com/pragtical/pragtical/commit/7d636075497dfbfa05fa2a9c89f018ddcbfdee29))

* fix: make get_custom_event_callback_by_name return NULL on invalid event name
  ([#2154](https://github.com/lite-xl/lite-xl/pull/2154))

* Added in check for the blink timer so that we don't needlessly redraw
  ([#2053](https://github.com/lite-xl/lite-xl/pull/2053))
