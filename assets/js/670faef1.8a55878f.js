"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3298],{6193:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var r=n(85893),t=n(11151);const i={sidebar_position:9,description:"Learn how to use the Process API to start and manage child processes."},o="Child Processes",c={id:"developer-guide/child-processes",title:"Child Processes",description:"Learn how to use the Process API to start and manage child processes.",source:"@site/docs/developer-guide/child-processes.md",sourceDirName:"developer-guide",slug:"/developer-guide/child-processes",permalink:"/docs/developer-guide/child-processes",draft:!1,unlisted:!1,editUrl:"https://github.com/pragtical/pragtical.github.io/edit/main/docs/developer-guide/child-processes.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{sidebar_position:9,description:"Learn how to use the Process API to start and manage child processes."},sidebar:"tutorialSidebar",previous:{title:"Interacting with the OS",permalink:"/docs/developer-guide/interacting-with-the-os"},next:{title:"Documents",permalink:"/docs/developer-guide/documents"}},d={},l=[{value:"Example: reading a file with <code>cat</code>",id:"example-reading-a-file-with-cat",level:2},{value:"Terms",id:"terms",level:2},{value:"Using the Process API",id:"using-the-process-api",level:2},{value:"Reading from a child process",id:"reading-from-a-child-process",level:3},{value:"Waiting for a child process",id:"waiting-for-a-child-process",level:3},{value:"Terminating a child process",id:"terminating-a-child-process",level:3},{value:"Miscellaneous",id:"miscellaneous",level:3},{value:"Error handling",id:"error-handling",level:3}];function a(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{id:"child-processes",children:"Child Processes"}),"\n",(0,r.jsxs)(s.p,{children:["Pragtical provides a process API to launch external applications.\nThis API is meant to replace Lua's ",(0,r.jsx)(s.code,{children:"io.popen"}),",\n",(0,r.jsx)(s.code,{children:"system.exec()"})," and lite's ",(0,r.jsx)(s.a,{href:"https://github.com/rxi/console/blob/fb3d414d085d4110364314d6cd8380dc1d386249/init.lua#L100",children:"pipe-to-a-file"})," approach."]}),"\n",(0,r.jsx)(s.p,{children:"Advantages of this API includes:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Proper argument escaping (arguments are supplied via a table)"}),"\n",(0,r.jsx)(s.li,{children:"Non-blocking IO"}),"\n",(0,r.jsx)(s.li,{children:"Able to detach processes from Pragtical"}),"\n",(0,r.jsx)(s.li,{children:"Does not create temporary files"}),"\n",(0,r.jsx)(s.li,{children:"Mostly cross-platform (does not require special code for each shell)"}),"\n",(0,r.jsx)(s.li,{children:"Does not create a console window on Windows"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"Unless you plan to run a command and forget about it, you should stick\nwith the Process API as it provides more features."}),"\n",(0,r.jsxs)(s.h2,{id:"example-reading-a-file-with-cat",children:["Example: reading a file with ",(0,r.jsx)(s.code,{children:"cat"})]}),"\n",(0,r.jsxs)(s.p,{children:["This example uses ",(0,r.jsx)(s.code,{children:"cat"})," to read a file. This approach is impractical,\nbut it demonstrates the typical usage of the Process API."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:'local core = require "core"\n\nlocal filename = "myfile.lua"\nlocal proc = process.start { "cat", filename }\n\n-- we use core.add_thread so that we don\'t softlock the editor\n-- while reading the output of the child process.\ncore.add_thread(function()\n  local readbuf = {}\n  while true do\n    -- yield so that the rest of the editor can carry out its tasks\n    -- eg. accepting input, updating the UI\n    coroutine.yield(1)\n\n    -- try to read from the standard output of the process.\n    local read = proc:read_stdout()\n    -- read == nil is a pretty good indication that the pipe is closed\n    -- therefore, no more data can be read.\n    if read == nil then break end\n    if read ~= "" then\n      -- if we read something, append it into the table\n      readbuf[#readbuf+1] = read\n    end\n    -- efficiently concatenate all the output into a string\n    local process_output = table.concat(readbuf)\n    -- note: never use core.log(process_output)!\n    -- core.log() accepts the same parameters as string.format(),\n    -- so you risk injecting invalid format strings!\n    core.log("read: %s", process_output)\nend)\n'})}),"\n",(0,r.jsx)(s.h2,{id:"terms",children:"Terms"}),"\n",(0,r.jsx)(s.p,{children:"To prevent confusion, these terms are used to describe various things:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Terms"}),(0,r.jsx)(s.th,{children:"Meaning"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Child process"}),(0,r.jsxs)(s.td,{children:["A process created with Process API via ",(0,r.jsx)(s.code,{children:"process.start()"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Parent process"}),(0,r.jsx)(s.td,{children:"The parent process that owns the child. This usually refers to Pragtical."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Process"}),(0,r.jsx)(s.td,{children:"Any process (including child and parent processes)."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Stream"}),(0,r.jsx)(s.td,{children:"An entity used to transfer data between child and parent processes. Think of it as a queue that can only be enqueued and dequeued."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Standard input"}),(0,r.jsx)(s.td,{children:"The standard input of most processes, also known as stdin."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Standard error"}),(0,r.jsx)(s.td,{children:"The standard error of most processes, also known as stderr."})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Standard output"}),(0,r.jsx)(s.td,{children:"The standard output of most processes, also known as stdout."})]})]})]}),"\n",(0,r.jsx)(s.h2,{id:"using-the-process-api",children:"Using the Process API"}),"\n",(0,r.jsxs)(s.p,{children:["To create a child process, use ",(0,r.jsx)(s.code,{children:"process.start()"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"local type RedirectType = number\n\nlocal record ProcessOptions\n  timeout: number,\n  cwd: string,\n  stdin: RedirectType,\n  stdout: RedirectType,\n  stderr: RedirectType,\n  env: {string: string}\nend\n\nfunction process.start(program_args: {string} | string,\n                        options: ProcessOptions): Process\nend\n"})}),"\n",(0,r.jsx)(s.p,{children:"The first argument of the function is a table containing the program name\nand its arguments.\nThe program name and its arguments need not be escaped as the API does it\nwhen necessary."}),"\n",(0,r.jsxs)(s.p,{children:["Since v2.1.0, users can provide a string instead of a table as the first\nargument to prevent the function from escaping them.\nThis may help with legacy software on Windows such as ",(0,r.jsx)(s.code,{children:"cmd.exe"}),".\nHowever, this should not be done on POSIX platforms as the entire string will be\ntreated as the program name and cause issues."]}),"\n",(0,r.jsx)(s.admonition,{title:"Before v2.1.0, this table is not escaped on Windows.",type:"note"}),"\n",(0,r.jsx)(s.p,{children:"The second argument specifies options to control process creation."}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"timeout"})," is an advisory value that will be used by ",(0,r.jsx)(s.code,{children:"process:wait()"})," and\nis optional."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"cwd"})," is the current working directory of the program.\nIf specified, the child process would run as if it was started in the directory."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"stdin"}),", ",(0,r.jsx)(s.code,{children:"stdout"})," and ",(0,r.jsx)(s.code,{children:"stderr"})," tells Pragtical how to treat standard\ninput and output of the child process.\nThere are four possible values:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"process.REDIRECT_DEFAULT"})," is the default behavior. It will be deprecated\nin future versions as specifying ",(0,r.jsx)(s.code,{children:"nil"})," is preferred."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"process.REDIRECT_PIPE"})," allows the Process API to write/read\nthe input/output of the child process."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"process.REDIRECT_PARENT"})," redirects the child process' input/output\nto the parent.\nIf ",(0,r.jsx)(s.code,{children:"stdin"})," has this value, child process will accept input from the parent\nprocess' console.\nIf ",(0,r.jsx)(s.code,{children:"stdout"})," or ",(0,r.jsx)(s.code,{children:"stderr"})," has this value, child process will output to the\nparent process' console."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"process.REDIRECT_DISCARD"})," discards any data to/from child process."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"process.REDIRECT_STDOUT"})," can only be used on ",(0,r.jsx)(s.code,{children:"stderr"})," and will redirect\nthe child process' standard error to its standard output."]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"env"})," is a table containing the environment variables for the child process as\nkey-value pairs."]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["On POSIX platforms, this table will ",(0,r.jsx)(s.strong,{children:"extend"})," the parent's environment.\nOn Windows, this table will ",(0,r.jsx)(s.strong,{children:"replace"})," the parent's environment.\nIn the future, this inconsistency may be fixed."]})}),"\n",(0,r.jsxs)(s.p,{children:["The function returns a ",(0,r.jsx)(s.code,{children:"Process"})," object that the user should hold onto until\nthe child process can be safely terminated.\nIf the ",(0,r.jsx)(s.code,{children:"Process"})," object is garbage-collected, the child process will be killed."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Examples:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:'-- run something in the background\nlocal proc = process.start { "bash", "-c", "echo hello world" }\n\n-- start a process and read its output\nlocal proc = process.start({ "cat", "myfile" }, { stdout = process.REDIRECT_PIPE })\n-- might or might not print something as the child process\n-- might not have written data to the standard output\nprint(proc:read_stdout())\n\n-- start a script with verbose output (accepting options over env vars)\nlocal proc = process.start({ "./site.rb" }, { env = { VERBOSE = "1" } })\n'})}),"\n",(0,r.jsx)(s.h3,{id:"reading-from-a-child-process",children:"Reading from a child process"}),"\n",(0,r.jsx)(s.p,{children:"If the child process is created with proper output modes,\none can read the standard output/error of the child process with the API."}),"\n",(0,r.jsxs)(s.p,{children:["To read from the child process' standard output, use ",(0,r.jsx)(s.code,{children:"process:read_stdout(len)"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["To read from the child process' standard error, use ",(0,r.jsx)(s.code,{children:"process:read_stderr(len)"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"function process:read_stdout(len?: number): string, string, number end\nfunction process:read_stderr(len?: number): string, string, number end\n"})}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"len"})," parameter is optional and is used to specify the maximum number of\nbytes to read from the stream."]}),"\n",(0,r.jsxs)(s.p,{children:["These methods return a string with size up to ",(0,r.jsx)(s.code,{children:"len"})," if data can be read.\nOtherwise, they will return ",(0,r.jsx)(s.code,{children:"nil"}),", an error message and the error code."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Examples:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"-- proc is a process with stdout set to process.REDIRECT_PIPE\n-- read default number of bytes (2048) from the process' standard output\nprint(proc:read_stdout())\n\n-- read default number of bytes (2048) from the process' standard error\n-- ensure that stderr of the process is not set to process.REDIRECT_STDOUT!\nprint(proc:read_stderr())\n"})}),"\n",(0,r.jsx)(s.h3,{id:"waiting-for-a-child-process",children:"Waiting for a child process"}),"\n",(0,r.jsx)(s.p,{children:"You might want to wait for a child process to end."}),"\n",(0,r.jsxs)(s.p,{children:["To check if a child process is still running, use ",(0,r.jsx)(s.code,{children:"process:running()"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["To wait for a child process to end, use ",(0,r.jsx)(s.code,{children:"process:wait(time)"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"function process:running(): boolean end\nfunction process:wait(timeout: number): number, string, number end\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:running()"})," returns a boolean immediately indicating whether the process\nhas ended."]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["Do not use ",(0,r.jsx)(s.code,{children:"process:running()"})," to determine when to stop reading the output\nof a child process.\nA child process can end and leave residual data in the stream.\nInstead, you should call ",(0,r.jsx)(s.code,{children:"process.read_stdout()"})," or ",(0,r.jsx)(s.code,{children:"process.read_stderr()"}),"\nuntil an appropriate error (",(0,r.jsx)(s.code,{children:"process.ERROR_PIPE"}),") occurs."]})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:wait(time)"})," will wait for specified number of milliseconds before\nreturning.\nIf the child process has ended, it will return the exit code of the process.\nIf the child process is still running or an error occurred,\nit will return ",(0,r.jsx)(s.code,{children:"nil"})," followed by an error message and error code."]}),"\n",(0,r.jsxs)(s.p,{children:["If ",(0,r.jsx)(s.code,{children:"time"})," is 0, the method returns immediately.\nIf ",(0,r.jsx)(s.code,{children:"time"})," is ",(0,r.jsx)(s.code,{children:"process.WAIT_INFINITE"}),", the method waits until the child process\nends.\nIf ",(0,r.jsx)(s.code,{children:"time"})," is ",(0,r.jsx)(s.code,{children:"process.WAIT_DEADLINE"}),", the method uses the ",(0,r.jsx)(s.code,{children:"timeout"})," value\nspecified when calling ",(0,r.jsx)(s.code,{children:"process.start()"}),".\nIf this value is not specified, it will wait until the child process ends."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Examples:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:'-- wait for a process to end\ncore.add_thread(function()\n  while process:running() do\n    coroutine.yield(0)\n    print("I am still running")\n  end\n  print("Oh no!")\nend)\n\n-- wait for a process to end, and print its exit code.\nprint("The process exited with the exit code " .. process:wait(process.WAIT_INFINITE))\n'})}),"\n",(0,r.jsx)(s.h3,{id:"terminating-a-child-process",children:"Terminating a child process"}),"\n",(0,r.jsx)(s.p,{children:"The Process API allows the user to terminate a child process gracefully\nor forcefully."}),"\n",(0,r.jsxs)(s.p,{children:["Use ",(0,r.jsx)(s.code,{children:"process:terminate()"})," to terminate a child process gracefully.\nIf it fails, use ",(0,r.jsx)(s.code,{children:"process:kill()"})," to forcefully terminate it."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"function process:terminate(): boolean, string, number end\nfunction process:kill(): boolean, string, number end\n"})}),"\n",(0,r.jsxs)(s.p,{children:["On POSIX platforms, ",(0,r.jsx)(s.code,{children:"process:terminate()"})," sends ",(0,r.jsx)(s.code,{children:"SIGTERM"})," to the child process\nwhile ",(0,r.jsx)(s.code,{children:"process:kill()"})," sends ",(0,r.jsx)(s.code,{children:"SIGKILL"})," to the child process."]}),"\n",(0,r.jsxs)(s.p,{children:["On Windows, ",(0,r.jsx)(s.code,{children:"process:terminate()"})," uses ",(0,r.jsx)(s.code,{children:"GenerateConsoleCtrlEvent(CTRL_BREAK_EVENT)"}),"\nto simulate CTRL+BREAK.\n",(0,r.jsx)(s.code,{children:"process:kill()"})," uses ",(0,r.jsx)(s.code,{children:"TerminateProcess()"})," to terminate the process immediately."]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:kill()"})," can only ",(0,r.jsx)(s.strong,{children:"request"})," a process to be killed.\nOn POSIX, signals are delivered asynchronously; a child process can be too\nbusy to process them (e.g. stuck at a blocking ",(0,r.jsx)(s.code,{children:"read()"})," or ",(0,r.jsx)(s.code,{children:"write()"})," call).\nThis is the same on Windows except ",(0,r.jsx)(s.code,{children:"TerminateProcess()"})," will\nrequest cancellation of all pending IO operations.\nThis is impossible on POSIX platforms."]})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Examples:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"-- try to terminate child process\nproc:terminate()\n\n-- wait for child process to end\nif not proc:wait(1000) then\n  -- didn't work, have to terminate it forcefully\n  proc:kill()\nend\n"})}),"\n",(0,r.jsx)(s.h3,{id:"miscellaneous",children:"Miscellaneous"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:pid()"})," can be used to obtain the PID of a child process.\nIt will return ",(0,r.jsx)(s.code,{children:"0"})," if the process is not running."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:returncode()"})," can be used to get the exit code of the child process\nwithout calling ",(0,r.jsx)(s.code,{children:"process:wait()"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process.strerror()"})," can be used to convert error codes emitted by the\nprocess API into human-readable error messages.\nIf an error message is unavailable, ",(0,r.jsx)(s.code,{children:"nil"})," will be returned."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:close_stream()"})," can be used to close the child process' streams."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-lua",children:"function process:pid(): number end\nfunction process:returncode(): number end\nfunction process.strerror(errcode: number): string end\nfunction process:close_stream(stream: number): number, string, number end\n"})}),"\n",(0,r.jsxs)(s.p,{children:["!!! note\n",(0,r.jsx)(s.code,{children:"process:pid()"})," will not return the correct process ID if\nthe child process ended early."]}),"\n",(0,r.jsx)(s.h3,{id:"error-handling",children:"Error handling"}),"\n",(0,r.jsx)(s.p,{children:"The Process API functions and methods\nwill return error messages/codes or throw errors."}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process.start()"})," will throw an error if the program cannot be run.\nOn Windows, this usually results in an error message\n",(0,r.jsx)(s.code,{children:'"Error creating a process: 2"'}),"."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"process:read()"}),", ",(0,r.jsx)(s.code,{children:"process:read_stdout()"}),", ",(0,r.jsx)(s.code,{children:"process:read_stderr()"})," and\n",(0,r.jsx)(s.code,{children:"process:write()"})," may throw errors if:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"The child process died."}),"\n",(0,r.jsx)(s.li,{children:"The child process closed their side of the input/output."}),"\n",(0,r.jsxs)(s.li,{children:["The input/output is closed via ",(0,r.jsx)(s.code,{children:"process:close_stream()"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Not all errors are documented here.\nIn general, it is recommended to call the functions with ",(0,r.jsx)(s.code,{children:"pcall()"})," until this\ninconsistency is fixed in the future."]})]})}function h(e={}){const{wrapper:s}={...(0,t.a)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},11151:(e,s,n)=>{n.d(s,{Z:()=>c,a:()=>o});var r=n(67294);const t={},i=r.createContext(t);function o(e){const s=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:s},e.children)}}}]);